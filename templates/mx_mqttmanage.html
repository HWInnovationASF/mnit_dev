<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
    <title>MQTT</title>
</head>
<body>
    <button onclick="window.location.href='/'">Home</button> <br>
    <!-- <a href="#" onclick="openVNC2()">Open VNC</a> -->
    <!-- <a href="vnc://172.16.110.149:5800">Open RealVNC via vnc://</a>
    <a href="vnc://172.16.110.149:5900">Open VNC Viewer</a> -->
    <!-- <a href="openvpn://connect?config=MyVPNConfig">Launch OpenVPN</a> -->
    

    <div style="display: flex;margin-bottom: 5px;">
        <div style="margin-right: 5px;">Device_SN: {{message}}</div>
    </div>

    <div class="hr-with-text">
        <span>Connect Step.</span>
    </div>
    <div style="display: flex;margin-bottom: 5px;">
        <div>[step.1]</div> <br>
        <input type="text" name="" id="topic1" value="meow/{{ message }}" >
        <button onclick="subscribeTopic('meow/{{ message }}')" style="margin-right: 5px;">Subscribe</button>
        <button onclick="unsubscribeTopic('meow/{{ message }}')" style="margin-right: 5px;">unSubscribe</button>
    </div>

    <div style="display: flex;margin-bottom: 5px;">
        <div>[step.2]</div> <br>
        <textarea name="" id="msg1" rows="5" cols="40"></textarea>
        <div>
            <button onclick="sendCMD('meow/{{ message }}','123')">send</button>
        </div>
    </div>

    <div class="hr-with-text">
        <span>Config</span>
    </div>

    <div style="display:flex;margin-bottom: 5px;">
        <button onclick='testMSG("meow/{{ message }}","{ \"mode\": \"pm2restart\", \"data\":{}, \"cmd_id\": \"C1728370820091\" }")' style="margin-right: 5px;">Re-run</button>
        <button onclick='testMSG("meow/{{ message }}","{ \"mode\": \"restart\", \"data\":{}, \"cmd_id\": \"C1728370820091\" }")' style="margin-right: 5px;">Restart</button>
    </div> 

    <div>
        <div></div>
    </div>
    <hr>

    
    <h3>Status:</h3>
    <div id="topics">-</div>
    <hr>


    <h1>Live Messages</h1>
    <ul id="messages">-</ul>
    <hr>

    <script>
        const socket = io();
        let ip_vpn;

        // function subscribeTopic(e) {
        //     e.preventDefault();
        //     const topic = document.getElementById("subTopic").value;
        //     console.log(topic);
            
        //     socket.emit('subscribe', { topic });
        // }
        function subscribeTopic(topic) {
            if (confirm("Are you sure you want to subscribe this?")) {
                // console.log("User clicked OK");
                // console.log(topic);
                let topic1 = document.getElementById("topic1").value;
                console.log("==== topic 1 : ",topic1);
                socket.emit('subscribe', { topic: topic1 });
            } else {
                console.log("User clicked Cancel");
            }
            // e.preventDefault();
            // const topic = document.getElementById("subTopic").value;
            // console.log(topic);
            
            // socket.emit('subscribe', { topic });
        }
        function unsubscribeTopic(topic) {
            if (confirm("Are you sure you want to unsubscribe this?")) {
                // console.log("User clicked OK");
                // console.log(topic);
                let topic1 = document.getElementById("topic1").value;
                console.log("==== topic 1 : ",topic1);
                socket.emit('unsubscribe', { topic: topic1 });
            } else {
                console.log("User clicked Cancel");
            }
            // e.preventDefault();
            // const topic = document.getElementById("subTopic").value;
            // console.log(topic);
            
            // socket.emit('unsubscribe', { topic });
        }
        function sendCMD(topic,cmd) {
            // e.preventDefault();
            // const topic = document.getElementById("subTopic").value;
            console.log(topic,cmd);
            let msg1 = document.getElementById("msg1").value;
            console.log("==== msg1 : ",msg1);
            
            socket.emit('sendCMD', { send_topic:topic,send_message:msg1 });
        }

        function copyText(id) {
            const text = document.getElementById(id).textContent;
            if(text){
                console.log("Text:", text);

                navigator.clipboard.writeText(text)
                .then(() => alert("Copied to clipboard!"))
                .catch(err => console.error("Copy failed", err));
            }else{
                console.log("text null");
                
            }
        }

        socket.on('mqtt_message', data => {
            const params = new URLSearchParams(window.location.search);
            const device_sn = params.get("device_sn"); 
            if(data.topic == 'meow/'+device_sn || data.topic == 'res/'+device_sn){
                const messagesDiv = document.getElementById("messages");
                const line = document.createElement("p");
                line.textContent = `[${data.topic}] ${data.message}`;
                // messagesDiv.appendChild(line);
                messagesDiv.innerHTML = `[${data.topic}] ${data.message}`;

                // ip_vpn
                let msg_arr = JSON.parse(data.message);

                // document.getElementById("messages").innerHTML = '';

                
                // if('ipvpn' in msg_arr){
                //     ip_vpn = msg_arr.ipvpn
                //     const ip_vpn_DIV = document.getElementById("ip-vpn");
                //     ip_vpn_DIV.innerHTML = `${ip_vpn}`;

                //     console.log(ip_vpn);
                //     document.getElementById("bt-ip-vpn").style.display = ip_vpn_DIV !== null ? "block" : "none";
                // }else{
                //     document.getElementById("bt-ip-vpn").style.display = 'none';
                //     console.log('============222');
                    
                // }
                // console.log(ip_vpn);

                
                
            }
        });
        

        socket.on('mqtt_topic', data => {
            const messagesDiv = document.getElementById("topics");
            const line = document.createElement("p");
            line.textContent = `[${data.topic}] ${data.message}`;
            // messagesDiv.appendChild(line);
            console.log(data);
            messagesDiv.innerHTML = `[${data.topic}] ${data.message}`;
            
        });

        socket.on('mqtt_sendCMD', function(data) {
            const messagesDiv = document.getElementById("topics");
            const line = document.createElement("p");
            line.textContent = `[${data.topic}] ${data.message}`;
            // messagesDiv.appendChild(line);
            messagesDiv.innerHTML = `[${data.topic}] ${data.message}`;
            
        });

        document.addEventListener("DOMContentLoaded", () => {
            const socket = io();

            socket.on('mqtt_response', data => {
                const output = document.getElementById('response');
                output.innerHTML = `
                    <p><strong>Topic:</strong> ${data.topic}</p>
                    <p><strong>Message:</strong> ${data.message}</p>
                `;
            });
        });

    </script>
    <style>
        .hr-with-text {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 10px 0;
        }

        .hr-with-text::before,
        .hr-with-text::after {
            content: "";
            flex: 1;
            border-bottom: 1px solid #999;
        }

        .hr-with-text span {
            padding: 0 10px;
            font-weight: bold;
            color: #444;
        }
    </style>
</body>

</html>

