<!doctype html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MQTT + SocketIO</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS Bundle (includes Popper) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body style="padding: 15px;">

            
    <div style="margin-bottom: 5px;margin-top: 5px;">
        <div>
            <button class="btn btn-primary" onclick="window.location.href='/debug/M1'" style="min-width: 75px;">M1</button>
            <button class="btn btn-primary" onclick="window.location.href='/debug/SQ'" style="min-width: 75px;">SQ</button>
            <button class="btn btn-primary"onclick="window.location.href='/debug/RL'" style="min-width: 75px;">RL</button>
            <button class="btn btn-primary" onclick="window.location.href='/debug/SI'" style="min-width: 75px;">SI</button>
            <button class="btn btn-primary" onclick="window.location.href='/debug/IR'" style="min-width: 75px;">IR</button>
            <button class="btn btn-primary" onclick="window.location.href='/debug/ALL'" style="min-width: 75px;">ALL</button>
        </div>
    </div>

    <div style="display: flex;align-items: center;justify-content: space-between;">
        <div>
            <button class="btn btn-warning" onclick="subscribeTopic('meow/#')" style="min-width: 75px;">Debug</button>
            <button class="btn btn-danger" onclick="unsubscribeTopic('meow/#')" style="min-width: 75px;">Stop</button>
        </div>
        <div style="display: flex;align-items: center;margin-top: 5px;">
            <label for="searchInput">Search:</label>&nbsp;
            <input type="text" class="form-control" name="searchInput" id="searchInput" onkeyup="filterTable()" placeholder="Search table...">
        </div>
    </div>
    <!-- <div style="display:flex;flex-direction: column;align-items: center;">
        {% for device_sn in data %}
        <div style="display:flex;">
            <input type="text" id="device_sn" value="{{ device_sn }}" disabled>
            <button onclick="window.location.href='/mqtt?device_sn={{ device_sn }}'">MQTT</button>
            <button onclick="linkpagr('vpn','{{ device_sn }}')">VPN</button>
        </div>
        {% endfor  %}
    </div> -->
    <!-- <div style="margin-top: 5px;">
        <input type="text" class="form control" id="searchInput" onkeyup="filterTable()" placeholder="Search table...">
    </div> -->
    <div style="overflow-y: scroll;">
        <table class="styled-table" id="myTable">
            <tr>
                <th>status</th>
                <th>device_SN</th>
                <th>DT</th>
                <!-- <th>TS_last</th> -->
                <th>WSData</th>
                <th>Toolkit</th>
            </tr>
            {% for data_k in data_arr %}
            {% if data_k.device_SN%}
            <tr>
                <td><div style="width:35px;"><div class="status-dev-{{ data_k.device_SN }}" style="width:25px;height:25px;border-radius:50%;background-color: #ddd;"></div></div></td>
                <td>{{data_k.device_SN}}</td>
                <td>{{data_k.DT}}</td>
                <!-- <td>{{data_k.TS_last}}</td> -->
                <td><textarea class="form-control" name="" id="" style="width:100%;height:20px;">{{data_k.WSData}}</textarea></td>
                <td>
                    <input type="hidden" id="device_sn" value="{{ data_k.device_SN }}" disabled>
                    <button class="btn btn-primary" onclick="window.location.href='/mqtt?device_sn={{ data_k.device_SN }}'">MQTT</button>
                    <!-- <button onclick="linkpagr('mqtt','{{ device_sn }}')">MQTT</button> -->
                    <!-- <button class="btn btn-primary" onclick="linkpagr('vpn','{{ data_k.device_SN }}')">VPN</button> -->
                    <button class="btn btn-primary" onclick="window.location.href='/dashboard?device_sn={{ data_k.device_SN }}'">Dashboard</button>
                    <button class="btn btn-primary" onclick="window.location.href='/config?device_sn={{ data_k.device_SN }}'">Config</button>

                </td>
            </tr>

            {% endif  %}
            {% endfor  %}
                
        </table>
    </div>
    

    <!-- <h1>MQTT messages (real-time)</h1>
    <ul id="messages"></ul> -->
    <script>
        let socket = io();

        function linkpagr(page,device_sn) {
            fetch('/mqtt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ device_sn: device_sn })
            })
            .then(response => {
                if (response.ok) {
                    // Redirect to another page after success
                    // window.location.href = "/pg"+page;
                } else {
                    console.error('POST failed');
                }
            })
            .catch(error => console.error('Error:', error));
        }
        function subscribeTopic(topic) {
            // e.preventDefault();
            // const topic = document.getElementById("subTopic").value;
            console.log(topic);
            
            socket.emit('subscribe', { topic });
        }
        function unsubscribeTopic(topic) {
            // e.preventDefault();
            // const topic = document.getElementById("subTopic").value;
            console.log(topic);
            
            socket.emit('unsubscribe', { topic });
        }


        function filterTable() {
            const input = document.getElementById("searchInput");
            const filter = input.value.toLowerCase();
            const table = document.getElementById("myTable");
            const tr = table.getElementsByTagName("tr");

            for (let i = 1; i < tr.length; i++) { // start at 1 to skip header
                let row = tr[i];
                let text = row.textContent || row.innerText;
                row.style.display = text.toLowerCase().includes(filter) ? "" : "none";
            }
        }

        socket.on('mqtt_message', data => {
            // const messagesDiv = document.getElementById("messages");
            // const line = document.createElement("p");
            // line.textContent = `[${data.topic}] ${data.message}`;
            // messagesDiv.appendChild(line);
            // messagesDiv.innerHTML = `[${data.topic}] ${data.message}`;
            // console.log(data.message);
            let msg_arr = JSON.parse(data.message);
            let res_ts = msg_arr.ts
            let device_SN = msg_arr.device_SN
            console.log(typeof(msg_arr),res_ts,device_SN);

            const status_dev = document.querySelector(".status-dev-"+device_SN);
            // const line = document.createElement("div");
            // status_dev.innerHTML = `ON`;
            if(status_dev){
                status_dev.innerHTML = '<div style="width:25px;height:25px;border-radius:50%;background-color: #00ff00;"></div>';
            }

            
            
            
        });
    </script>

    <style>
        .styled-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 16px;
            text-align: left;
        }

        .styled-table th,
        .styled-table td {
            padding: 8px 10px;
            border: 1px solid #ddd;
            text-wrap: nowrap;
        }

        .styled-table thead {
            background-color: #009879;
            color: #ffffff;
        }

        .styled-table tbody tr:nth-child(even) {
            background-color: #f3f3f3;
        }

        .styled-table tbody tr:hover {
            background-color: #f1f1f1;
        }
    </style>


</body>
</html>
